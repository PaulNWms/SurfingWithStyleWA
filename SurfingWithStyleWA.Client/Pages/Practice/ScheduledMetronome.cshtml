@page "/practice/scheduledmetronome"
@inject Microsoft.AspNetCore.Blazor.Services.IUriHelper UriHelper

<style>
    .pendulum-parent {
        animation: @animation @duration ease-in-out alternate infinite;
    }
</style>
<article class="narrow-article mini-metronome" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/WebApplication">
    @*@{Html.RenderPartial("~/Views/Shared/_StructuredData.cshtml", ViewBag as object);}*@
    <meta itemprop="applicationCategory" content="Tool, Multimedia" />
    <meta itemprop="applicationSubCategory" content="Music Rehearsal" />
    <meta itemprop="operatingSystem" content="IIS/ASP.NET MVC" />
    <h2>Scheduled Metronome</h2>
    <div class="row">
        <div class="col-9 jumbotron text-center">
            <div class="row">
                <button class="offset-3 btn btn-primary btn-lg start" type="button" onclick="@StartMetronome"><span class="oi @Timer.buttonFace"></span></button>
                <h1 class="offset-1 display"><span class="display">@Tempo</span></h1>
            </div>
            <br />
            <div class="row">
                <h2 class="col-3">
                    <span class="timer-display">0:00</span>
                </h2>
                <h2 class="col-9">
                    <span class="exercise-display"></span>
                </h2>
            </div>
        </div>
        <div class="offset-1 col-offset2">
            <div class="metronome-object">
                <div class="pendulum-crossbar">
                    <div class="pendulum-grandparent">
                        <div class="pendulum-parent">
                            <div class="pendulum-child"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <h3 class="offset-2">Schedule:</h3>
    </div>
    <div class="row">
        <table class="table offset-2 col-7">
            <thead>
                <tr>
                    <th></th>
                    <th>Tempo</th>
                    <th>Time</th>
                    <th>Exercise</th>
                    <th></th>
                </tr>
            </thead>
            <tbody class="schedule">
                @((MarkupString)exerciseMarkup)
            </tbody>
        </table>
        <div class="row form-group offset-2 col-7">
            <label for="Rest">Rest between exercises (sec.): </label>
            <input name="Rest" class="form-control digit-filter rest" id="rest" type="text" value="@schedule.Rest"
                   style="width:3em;margin-top:0.2em;padding-left:0.3em;padding-right:0.3em;">
        </div>
        <div class="row form-group offset-2 col-7">
            <label for="StartRoutineWithRest">Start routine with a rest: </label>
            <input name="StartRoutineWithRest" class="start-with-rest" id="StartRoutineWithRest" type="checkbox" bind="@schedule.StartWithRest" />
        </div>
        <div class="row form-group offset-2 col-7">
            <label for="EndExerciseWithBell">End each exercise with a bell: </label>
            <input name="EndExerciseWithBell" class="end-with-bell" id="EndExerciseWithBell" type="checkbox" bind="@schedule.EndWithBell" />
        </div>
        <div class="row offset-2 col-7">
            <div class="form-group">
                 <button class="btn btn-primary btn-lg active" onclick="@CreateLink">Create Link</button>
            </div>
        </div>
    </div>
    <div class="row">
        <audio class="downbeat-click" preload="auto" hidden="hidden">
            <source src="audio/downbeatClick.wav" type="audio/wav">
            <source src="audio/downbeatClick.mp3" type="audio/mp3">
        </audio>
        <audio class="end-exercise-bell" preload="auto">
            <source src="audio/EndExercise.wav" type="audio/wav">
            <source src="audio/EndExercise.mp3" type="audio/mp3">
        </audio>
        <audio class="end-routine-bell" preload="auto">
            <source src="audio/EndRoutine.wav" type="audio/wav">
            <source src="audio/EndRoutine.mp3" type="audio/mp3">
        </audio>
    </div>
</article>

@functions {
    enum TimerState { Stopped, Running, Paused, Continuing, Settling };

    const int MIN_TEMPO = 20;
    const int MAX_TEMPO = 240;
    string animation = "none";
    string duration = "500ms";
    bool initialized;
    Schedule schedule;
    string exerciseMarkup;

    int _tempo = 120;
    int Tempo
    {
        get
        {
            return _tempo;
        }
        set
        {
            _tempo = value;
            duration = ((int)(60000.0 / _tempo)).ToString() + "ms";
            SetAnimation();
        }
    }

    bool _isRunning = false;
    bool IsRunning
    {
        get
        {
            return _isRunning;
        }
        set
        {
            _isRunning = value;
            SetAnimation();
        }
    }

    protected override void OnInit()
    {
        base.OnInit();

        Uri uri = new Uri(UriHelper.GetAbsoluteUri());
        schedule = new Schedule(uri);
        exerciseMarkup = schedule.ToHtml();
        this.StateHasChanged();
    }

    protected override void OnAfterRender()
    {
        base.OnAfterRender();

        if (!initialized)
        {
            JSRuntime.Current.InvokeAsync<object>("registerListener");
            string newRow = string.Format(Schedule.HTML_TEMPLATE, 120, "2:00", string.Empty);
            JSRuntime.Current.InvokeAsync<object>("registerFormRowListener", newRow);
            initialized = true;
        }
    }

    public async void CreateLink()
    {
        try
        {
            await schedule.ParseControls();
            string url = schedule.ToUrl();
            await JSRuntime.Current.InvokeAsync<object>("window.open", url);
        }
        catch (Exception e)
        {
            await JSRuntime.Current.InvokeAsync<object>("alert", e.Message + e.StackTrace);
        }
    }

    void DecrementTempo() { Tempo = Math.Max(Tempo - 1, MIN_TEMPO); }
    void IncrementTempo() { Tempo = Math.Min(Tempo + 1, MAX_TEMPO); }

    void SetAnimation()
    {
        if (IsRunning)
        {
            if (animation == "swing0")
                animation = "swing1";
            else
                animation = "swing0";
        }
        else
        {
            animation = "none";
        }
    }

    void StartMetronome()
    {
        switch (Timer.status)
        {
            case TimerState.Stopped:
                Timer.buttonFace = "oi-media-pause";
                Timer.status = TimerState.Running;
                IsRunning = true;
                break;

            case TimerState.Paused:
                Timer.buttonFace = "oi-media-pause";
                Timer.status = TimerState.Running;
                IsRunning = true;
                break;

            case TimerState.Running:
                Timer.buttonFace = "oi-media-play";
                Timer.status = TimerState.Paused;
                IsRunning = false;
                break;

            default:
                break;
        }
    }

    public void Dispose()
    {
        //TODO: timer.Elapsed -= OnTimer;
    }

    class Timer
    {
        public static TimerState status = TimerState.Stopped;
        public static string buttonFace = "oi-media-play";

        private TimeSpan duration = new TimeSpan(0, 25, 0);
        DateTime targetTime = DateTime.Now;
        string timerDisplay = "25:00";
        System.Timers.Timer timer = new System.Timers.Timer(1000);

        public Timer()
        {

        }

        void UpdateButton(TimerState state)
        {
            status = state;
            switch (status)
            {
                case TimerState.Stopped:
                case TimerState.Paused:
                    buttonFace = "oi-media-play";
                    break;

                case TimerState.Running:
                    buttonFace = "oi-media-pause";
                    break;
            }
        }

        private string RoundAndTrimDuration(TimeSpan span)
        {
            const double factor = 10000000;
            long boundedTicks = Math.Max(span.Ticks, 0);
            long roundedTicks = (long)(Math.Round(boundedTicks / factor) * factor);
            TimeSpan roundedTimeSpan = new TimeSpan(roundedTicks);
            string str = roundedTimeSpan.ToString();
            int i = 0;

            for (i = 0; i < str.Length - 4; i++)
            {
                if (str[i] != '0' && str[i] != ':')
                    break;
            }

            return str.Substring(i);
        }

        void OnTimer(Object source, System.Timers.ElapsedEventArgs e)
        {
            duration = targetTime - e.SignalTime;
            timerDisplay = RoundAndTrimDuration(duration);
            JSRuntime.Current.InvokeAsync<object>("setTitle", timerDisplay);

            if (timerDisplay == "0:00")
            {
                TimerExpired();
            }

            // TODO:this.StateHasChanged();
        }

        void TimerExpired()
        {
            targetTime = DateTime.Now;
            JSRuntime.Current.InvokeAsync<object>("colorBody");
            JSRuntime.Current.InvokeAsync<object>("playAudio");
            UpdateButton(TimerState.Stopped);
            timer.Stop();
        }
    }

    class Schedule
    {
        private Uri uri;
        public TimeSpan Rest;
        public bool StartWithRest;
        public bool EndWithBell;

        private List<Exercise> exercises;

        public Schedule(Uri uri)
        {
            this.uri = uri;
            this.Rest = new TimeSpan(0, 0, 5);
            this.StartWithRest = true;
            this.EndWithBell = true;
            ParseUrl();
        }

        public async Task ParseControls()
        {
            var regex = new System.Text.RegularExpressions.Regex(@"(\d+):(\d\d)");
            exercises = new List<Exercise>();
            List<List<string>> raw = await JSRuntime.Current.InvokeAsync<List<List<string>>>("getExerciselValues");

            if (raw[0].Count != raw[1].Count || raw[1].Count != raw[2].Count)
            {
                throw new DataMisalignedException(string.Format("Lists are different lengths: {0} {1} {2}", raw[0].Count, raw[1].Count, raw[3].Count));
            }

            for (int i = 0; i < raw[0].Count; i++)
            {
                int tempo;
                int minutes;
                int seconds;
                TimeSpan duration;

                if (int.TryParse(raw[0][i], out tempo))
                {
                    System.Text.RegularExpressions.Match match = regex.Match(raw[1][i]);

                    if (match.Success)
                    {
                        minutes = int.Parse(match.Groups[1].Value);
                        seconds = int.Parse(match.Groups[2].Value);
                        duration = new TimeSpan(0, minutes, seconds);
                    }
                    else if (int.TryParse(raw[1][i], out seconds))
                    {
                        duration = new TimeSpan(0, 0, seconds);
                    }
                }

                if (duration.Ticks == 0)
                {
                    throw new ArgumentException(string.Format("Invalid time format: {0}", raw[1][i]));
                }

                exercises.Add(new Exercise() { Tempo = tempo, Duration = duration, Description = raw[2][i] });
            }
        }

        private void ParseUrl()
        {
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(this.uri.Query);
            int[] tempos = null;
            TimeSpan[] durations = null;
            string[] exes = null;
            exercises = new List<Exercise>();

            if (query.ContainsKey("r"))
            {
                foreach (var key in query.Keys)
                {
                    switch (key)
                    {
                        case "r":
                            {
                                int rest;
                                if (int.TryParse(query["r"].ToString(), out rest))
                                {
                                    this.Rest = new TimeSpan(0, 0, rest);
                                }
                            }
                            break;

                        case "s":
                            bool.TryParse(query["s"].ToString(), out this.StartWithRest);
                            break;

                        case "b":
                            bool.TryParse(query["b"].ToString(), out this.EndWithBell);
                            break;

                        case "t":
                            {
                                string[] strs = query["t"].ToString().Split('-');
                                List<int> ts = new List<int>(strs.Length);

                                foreach (string str in strs)
                                {
                                    int tempo;

                                    if (int.TryParse(str, out tempo))
                                    {
                                        ts.Add(tempo);
                                    }
                                    else
                                    {
                                        ts.Add(120);
                                    }
                                }

                                tempos = ts.ToArray();
                            }
                            break;

                        case "d":
                            {
                                string[] strs = query["d"].ToString().Split('-');
                                List<TimeSpan> durs = new List<TimeSpan>(strs.Length);

                                foreach (string str in strs)
                                {
                                    int sec;

                                    if (int.TryParse(str, out sec))
                                    {
                                        durs.Add(new TimeSpan(0, 0, sec));
                                    }
                                    else
                                    {
                                        durs.Add(new TimeSpan(0, 0, 120));
                                    }
                                }

                                durations = durs.ToArray();
                            }
                            break;

                        case "e":
                            exes = query["e"].ToString().Split('-');
                            break;
                    }
                }

                for (int i = 0; i < tempos.Length; i++)
                {
                    this.exercises.Add(new Exercise() { Tempo = tempos[i], Duration = durations[i], Description = exes[i] });
                }
            }
            else
            {
                this.exercises.Add(new Exercise() { Tempo = 120, Duration = new TimeSpan(0, 2, 0), Description = string.Empty });
            }
        }

        private List<Exercise> ToTimeline()
        {
            List<Exercise> timeline = new List<Exercise>();
            var restStep = new Exercise() { Tempo = 0, Duration = this.Rest, Description = "Resting..." };

            if (exercises.Count > 0 && this.Rest.Ticks > 0 && this.StartWithRest)
            {
                timeline.Add(restStep);
            }

            for (var i = 0; i < exercises.Count; i++)
            {
                timeline.Add(exercises[i]);

                if (i < exercises.Count - 1 && this.Rest.Ticks > 0)
                {
                    timeline.Add(restStep);
                }
            }

            return timeline;
        }

        public string ToUrl()
        {
            List<int> tempos = new List<int>(exercises.Count);
            List<TimeSpan> durations = new List<TimeSpan>(exercises.Count);
            List<string> descriptions = new List<string>(exercises.Count);

            foreach (var exercise in exercises)
            {
                tempos.Add(exercise.Tempo);
                durations.Add(exercise.Duration);
                descriptions.Add(exercise.Description);
            }

            string ts = string.Join("-", tempos);
            string ds = string.Join("-", durations.Select(d => (int)d.TotalSeconds));
            string es = string.Join("-", descriptions.Select(e => Uri.EscapeUriString(e)));
            return String.Format(URL_TEMPLATE, uri.AbsolutePath,
                this.Rest,
                this.StartWithRest.ToString().ToLower(),
                this.EndWithBell.ToString().ToLower(),
                ts, ds, es);
        }

        public string ToHtml()
        {
            System.Text.StringBuilder sb = new System.Text.StringBuilder();
            foreach (var exercise in exercises)
            {
                sb.AppendLine(string.Format(HTML_TEMPLATE,
                    exercise.Tempo,
                    exercise.Duration.ToString(@"m\:ss"),
                    exercise.Description));
            }

            return sb.ToString();
        }

        const string URL_TEMPLATE = "{0}?r={1}&s={2}&b={3}&t={4}&d={5}&e={6}";

        public const string HTML_TEMPLATE = @"                        <tr>
                    <td>
                        <button type='button' class='btn btn-primary delete-form-row' style='margin-top:0.2em;margin-right:0.2em'><span class='oi oi-x'></span></button>
                    </td>
                    <td>
                        <input type='text' style='width:3em;margin-top:0.2em;margin-right:0.2em;padding-left:0.3em;padding-right:0.3em' class='form-control digit-filter tempo tempo-0' id='tempo-0' placeholder='Tempo' autocomplete='off' value='{0}' />
                    </td>
                    <td>
                        <input type='text' style='width:3.5em;margin-top:0.2em;margin-right:0.2em;padding-left:0.5em;padding-right:0.5em' class='form-control time-filter midpoint-0' id='midpoint-0' placeholder='Duration' autocomplete='off' value='{1}' />
                        <input type='hidden'class='midpoint-0-sec' />
                    </td>
                    <td>
                        <input type='text' style='margin-top:0.2em;margin-right:0.2em' class='form-control exercise' id='exercise' placeholder='Exercise' value='{2}' />
                    </td>
                    <td>
                        <button type='button' class='btn btn-primary add-form-row' style='margin-top:0.2em' onclick='@AddRow'><span class='oi oi-plus'></span></button>
                    </td>
                </tr>";
    }

    struct Exercise
    {
        public int Tempo;
        public TimeSpan Duration;
        public string Description;
    }
}
